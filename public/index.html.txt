<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Research Survey</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      text-align: center;
      color: #202124;
      margin-bottom: 30px;
    }
    .section-description {
      margin-bottom: 15px;
      font-size: 1rem;
      color: #5f6368;
    }
    .question-block {
      background: white;
      border-left: 5px solid #1a73e8; /* Google Blue */
      padding: 15px 20px;
      margin-bottom: 25px;
      box-shadow: 0 1px 3px rgba(60,64,67,.3);
      border-radius: 4px;
    }
    .question-block p {
      margin: 0 0 10px 0;
      font-weight: 600;
      color: #202124;
    }
    .question-block label {
      display: block;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 1rem;
      color: #202124;
    }
    input[type="radio"] {
      margin-right: 12px;
      cursor: pointer;
    }
    textarea {
      font-family: Arial, sans-serif;
      font-size: 1rem;
      padding: 8px;
      resize: vertical;
    }
    .likert-scale {
      display: flex;
      justify-content: space-between;
      max-width: 420px;
      margin-top: 8px;
      margin-bottom: 20px;
    }
    .likert-scale label {
      flex: 1;
      text-align: center;
      font-size: 0.85rem;
      cursor: pointer;
      user-select: none;
    }
    .likert-scale input[type="radio"] {
      margin-right: 6px;
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 1.1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
      float: right;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: #155ab6;
    }
    button:disabled {
      background-color: #a8c0f0;
      cursor: not-allowed;
    }
    iframe {
      width: 100%;
      height: 315px;
      border: none;
      margin-bottom: 10px;
    }
    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
  </style>
</head>
<body>

  <h1>Research Survey</h1>

  <form id="surveyForm" autocomplete="off">

    <!-- Section 0: Welcome + Demographics + Logic Q1 -->
    <div class="section" data-section-index="0">
      <p class="section-description">
        Hello, my name is M Majid and I am a sophomore at the Marine Academy of Technology and Environmental Science.
        I am conducting a survey for my research project regarding different cognitive styles.
        This short study includes a series of 20-second videos, logic questions and self assessments.
        When you submit this form, it will not automatically collect your details like name and email address unless you provide it yourself.
      </p>

      <p class="section-description">
        Demographics Section: This section collects general information about participants to help us understand the background of respondents and ensure the study includes a diverse group.
        Your responses are confidential and used only for research purposes.
      </p>

      <div class="question-block" id="ageRangeBlock">
        <p>What is your age range?</p>
        <label><input type="radio" name="ageRange" value="0-13" required> 0-13</label>
        <label><input type="radio" name="ageRange" value="14-29"> 14-29</label>
        <label><input type="radio" name="ageRange" value="30-45"> 30-45</label>
        <label><input type="radio" name="ageRange" value="46-61"> 46-61</label>
        <label><input type="radio" name="ageRange" value="62-80"> 62-80</label>
      </div>

      <div class="question-block" id="ethnicityBlock">
        <p>What is your ethnicity?</p>
        <label><input type="radio" name="ethnicity" value="White/Caucasian" required> White/Caucasian</label>
        <label><input type="radio" name="ethnicity" value="Black or African-American"> Black or African-American</label>
        <label><input type="radio" name="ethnicity" value="American Indian or Alaskan Native"> American Indian or Alaskan Native</label>
        <label><input type="radio" name="ethnicity" value="Asian/Asian-American"> Asian/Asian-American</label>
        <label><input type="radio" name="ethnicity" value="Native Hawaiian or other Pacific islander"> Native Hawaiian or other Pacific islander</label>
        <label><input type="radio" name="ethnicity" value="From multiple races"> From multiple races</label>
        <label><input type="radio" name="ethnicity" value="Prefer not to disclose"> Prefer not to disclose</label>
      </div>

      <div class="question-block" id="logicQ1Block">
        <p>A frog climbs up 4 feet but slips down 1 foot every minute.<br>How many feet does the frog climb in 3 minutes?</p>
        <label><input type="radio" name="frogClimbAnswer" value="9 feet" required> A) 9 feet</label>
        <label><input type="radio" name="frogClimbAnswer" value="12 feet"> B) 12 feet</label>
        <label><input type="radio" name="frogClimbAnswer" value="7 feet"> C) 7 feet</label>
        <label><input type="radio" name="frogClimbAnswer" value="3 feet"> D) 3 feet</label>
      </div>
    </div>

    <!-- Section 1: Video 1 -->
    <div class="section" data-section-index="1" style="display:none;">
      <p class="section-description">
        Please watch the following video fully. Proceed to the next section after you are done.
      </p>
      <iframe id="video1" src="https://www.youtube.com/embed/PIP4TXsbTgY?enablejsapi=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      <p id="video1-timer" style="font-weight:bold; color:#d93025;">
        You must watch the full 48 seconds before proceeding. (<span id="video1-time-left">48</span>s left)
      </p>
    </div>

    <!-- Section 2: Question 1 -->
    <div class="section" data-section-index="2" style="display:none;">
      <p class="section-description">
        Please answer the following questions honestly and to the best of your ability.
      </p>

      <div class="question-block" id="q1Block">
        <p>Jerry had 20 cups of juice. He drank all but 9 of them.<br>How many cups does Jerry have left?</p>
        <label><input type="radio" name="q1Answer" value="9" required> A) 9</label>
        <label><input type="radio" name="q1Answer" value="11"> B) 11</label>
        <label><input type="radio" name="q1Answer" value="0"> C) 0</label>
        <label><input type="radio" name="q1Answer" value="20"> D) 20</label>
      </div>

      <div class="question-block" id="confidenceQ1Block">
        <p>How confident are you about your answer?</p>
        <div class="likert-scale" id="likertQ1">
          <label><input type="radio" name="q1Confidence" value="1" required> Not at all confident</label>
          <label><input type="radio" name="q1Confidence" value="2"> 2</label>
          <label><input type="radio" name="q1Confidence" value="3"> 3</label>
          <label><input type="radio" name="q1Confidence" value="4"> 4</label>
          <label><input type="radio" name="q1Confidence" value="5"> Very confident</label>
        </div>
      </div>

      <div class="question-block" id="realFakeQ1Block">
        <p>Is this video real or fake?</p>
        <label><input type="radio" name="q1RealFake" value="Real" required> Real</label>
        <label><input type="radio" name="q1RealFake" value="Fake"> Fake</label>
      </div>

      <div class="question-block" id="feelingQ1Block">
        <p>How did this video make you feel?</p>
        <textarea name="q1Feeling" rows="3" style="width:100%;" required></textarea>
      </div>
    </div>

    <!-- Section 3: Video 2 -->
    <div class="section" data-section-index="3" style="display:none;">
      <p class="section-description">
        Please watch the following video fully. Proceed to the next section after you are done.
      </p>
      <iframe id="video2" src="https://www.youtube.com/embed/aRCK2vjnIqs?enablejsapi=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      <p id="video2-timer" style="font-weight:bold; color:#d93025;">
        You must watch the full 48 seconds before proceeding. (<span id="video2-time-left">48</span>s left)
      </p>
    </div>

    <!-- Section 4: Question 2 -->
    <div class="section" data-section-index="4" style="display:none;">
      <p class="section-description">
        Please answer the following questions honestly and to the best of your ability.
      </p>

      <div class="question-block" id="q2Block">
        <p>There are 10 cookies in the jar. You take away 4 cookies.<br>How many cookies do you have?</p>
        <label><input type="radio" name="q2Answer" value="4" required> A) 4</label>
        <label><input type="radio" name="q2Answer" value="6"> B) 6</label>
        <label><input type="radio" name="q2Answer" value="10"> C) 10</label>
        <label><input type="radio" name="q2Answer" value="0"> D) 0</label>
      </div>

      <div class="question-block" id="confidenceQ2Block">
        <p>How confident are you about your answer?</p>
        <div class="likert-scale" id="likertQ2">
          <label><input type="radio" name="q2Confidence" value="1" required> Not at all confident</label>
          <label><input type="radio" name="q2Confidence" value="2"> 2</label>
          <label><input type="radio" name="q2Confidence" value="3"> 3</label>
          <label><input type="radio" name="q2Confidence" value="4"> 4</label>
          <label><input type="radio" name="q2Confidence" value="5"> Very confident</label>
        </div>
      </div>

      <div class="question-block" id="realFakeQ2Block">
        <p>Is this video real or fake?</p>
        <label><input type="radio" name="q2RealFake" value="Real" required> Real</label>
        <label><input type="radio" name="q2RealFake" value="Fake"> Fake</label>
      </div>

      <div class="question-block" id="feelingQ2Block">
        <p>How did this video make you feel?</p>
        <textarea name="q2Feeling" rows="3" style="width:100%;" required></textarea>
      </div>
    </div>

    <!-- Section 5: Video 3 -->
    <div class="section" data-section-index="5" style="display:none;">
      <p class="section-description">
        Please watch the following video fully. Proceed to the next section after you are done.
      </p>
      <iframe id="video3" src="https://www.youtube.com/embed/RWUx0NnOpnU?enablejsapi=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      <p id="video3-timer" style="font-weight:bold; color:#d93025;">
        You must watch the full 48 seconds before proceeding. (<span id="video3-time-left">48</span>s left)
      </p>
    </div>

    <!-- Section 6: Question 3 -->
    <div class="section" data-section-index="6" style="display:none;">
      <p class="section-description">
        Please answer the following questions to the best of your ability.
      </p>

      <div class="question-block" id="q3Block">
        <p>A soccer ball costs $3 and a pair of shoes costs $7 more than the ball. How much do the shoes cost?</p>
        <label><input type="radio" name="q3Answer" value="$7" required> A) $7</label>
        <label><input type="radio"
        <label><input type="radio" name="q3Answer" value="$10"> B) $10</label>
        <label><input type="radio" name="q3Answer" value="$3"> C) $3</label>
        <label><input type="radio" name="q3Answer" value="$4"> D) $4</label>
      </div>

      <div class="question-block" id="confidenceQ3Block">
        <p>How confident are you about your answer?</p>
        <div class="likert-scale" id="likertQ3">
          <label><input type="radio" name="q3Confidence" value="1" required> Not at all confident</label>
          <label><input type="radio" name="q3Confidence" value="2"> 2</label>
          <label><input type="radio" name="q3Confidence" value="3"> 3</label>
          <label><input type="radio" name="q3Confidence" value="4"> 4</label>
          <label><input type="radio" name="q3Confidence" value="5"> Very confident</label>
        </div>
      </div>

      <div class="question-block" id="realFakeQ3Block">
        <p>Is this video real or fake?</p>
        <label><input type="radio" name="q3RealFake" value="Real" required> Real</label>
        <label><input type="radio" name="q3RealFake" value="Fake"> Fake</label>
      </div>

      <div class="question-block" id="feelingQ3Block">
        <p>How did this video make you feel?</p>
        <textarea name="q3Feeling" rows="3" style="width:100%;" required></textarea>
      </div>
    </div>

    <!-- Section 7: Thank You -->
    <div class="section" data-section-index="7" style="display:none; text-align:center;">
      <h2>Thank you for your submission!</h2>
      <p>Your responses have been recorded.</p>
    </div>

    <div class="clearfix">
      <button type="button" id="prevBtn" style="display:none;">Previous</button>
      <button type="button" id="nextBtn">Next</button>
    </div>
  </form>

  <script>
    // Video sections index and duration in seconds
    const VIDEO_SECTIONS = [1, 3, 5];
    const VIDEO_DURATION = 48;

    const sections = document.querySelectorAll('.section');
    let currentSection = 0;

    // Track time spent on all sections (except video sections)
    let sectionTimes = Array(sections.length).fill(0);
    let sectionStartTime = Date.now();

    // YouTube iframe API setup to control videos
    let players = {};

    function onYouTubeIframeAPIReady() {
      ['video1', 'video2', 'video3'].forEach(id => {
        players[id] = new YT.Player(id);
      });
    }

    // Load YouTube iframe API
    let tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    // Video timers and control
    let videoTimers = {};
    let canProceed = false;

    function startVideoTimer(sectionIdx) {
      canProceed = false;
      let timerId = `video${(sectionIdx + 1)}-timer`;
      const timerEl = document.getElementById(timerId);
      let timeLeft = VIDEO_DURATION;
      const timeLeftSpan = timerEl.querySelector(`#video${(sectionIdx + 1)}-time-left`);
      if (!timeLeftSpan) {
        // Fallback if span not found, set text content directly
        timerEl.textContent = `You must watch the full ${VIDEO_DURATION} seconds before proceeding. (${timeLeft}s left)`;
      }

      document.getElementById('nextBtn').disabled = true;

      videoTimers[sectionIdx] = setInterval(() => {
        timeLeft--;
        if (timeLeftSpan) {
          timeLeftSpan.textContent = timeLeft;
        } else {
          timerEl.textContent = `You must watch the full ${VIDEO_DURATION} seconds before proceeding. (${timeLeft}s left)`;
        }

        if (timeLeft <= 0) {
          clearInterval(videoTimers[sectionIdx]);
          timerEl.textContent = "You may now proceed.";
          canProceed = true;
          document.getElementById('nextBtn').disabled = false;
        }
      }, 1000);
    }

    function stopVideoTimer(sectionIdx) {
      clearInterval(videoTimers[sectionIdx]);
      canProceed = true;
      document.getElementById('nextBtn').disabled = false;
    }

    // Pause all videos when switching sections
    function stopAllVideos() {
      Object.values(players).forEach(player => {
        if (player && typeof player.pauseVideo === 'function') {
          player.pauseVideo();
        }
      });
    }

    // Show a given section index and hide others
    function showSection(index) {
      sections.forEach((section, i) => {
        section.style.display = (i === index) ? 'block' : 'none';
      });

      // Update buttons visibility & text
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      prevBtn.style.display = (index === 0) ? 'none' : 'inline-block';

      if (index === sections.length - 1) {
        nextBtn.textContent = 'Submit';
      } else {
        nextBtn.textContent = 'Next';
      }

      // Disable next button for video sections until timer completes
      if (VIDEO_SECTIONS.includes(index)) {
        document.getElementById('nextBtn').disabled = true;
        startVideoTimer(index);
      } else {
        document.getElementById('nextBtn').disabled = false;
      }

      sectionStartTime = Date.now();
    }

    // Validate that all required fields in current section are answered
    function validateSection(index) {
      const section = sections[index];
      const inputs = section.querySelectorAll('input, textarea, select');

      for (let input of inputs) {
        if (input.hasAttribute('required')) {
          if ((input.type === 'radio' || input.type === 'checkbox') && !section.querySelector(`input[name="${input.name}"]:checked`)) {
            alert('Please answer all required questions before proceeding.');
            return false;
          }
          if ((input.tagName === 'TEXTAREA' || input.tagName === 'SELECT') && !input.value.trim()) {
            alert('Please answer all required questions before proceeding.');
            return false;
          }
        }
      }

      // For video sections, must wait full time
      if (VIDEO_SECTIONS.includes(index) && !canProceed) {
        alert(`You must watch the full ${VIDEO_DURATION} seconds before proceeding.`);
        return false;
      }

      return true;
    }

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (!validateSection(currentSection)) return;

      // Save time spent on current section
      sectionTimes[currentSection] += Math.floor((Date.now() - sectionStartTime) / 1000);

      // If video section, stop timer and pause videos
      if (VIDEO_SECTIONS.includes(currentSection)) {
        stopVideoTimer(currentSection);
        stopAllVideos();
      }

      if (currentSection === sections.length - 1) {
        submitSurvey();
        return;
      }

      currentSection++;
      showSection(currentSection);
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
      // Save time spent on current section
      sectionTimes[currentSection] += Math.floor((Date.now() - sectionStartTime) / 1000);

      if (VIDEO_SECTIONS.includes(currentSection)) {
        stopVideoTimer(currentSection);
        stopAllVideos();
      }

      currentSection--;
      showSection(currentSection);
    });

    function submitSurvey() {
      const form = document.getElementById('surveyForm');
      const formData = new FormData(form);
      const data = {};

      formData.forEach((value, key) => {
        data[key] = value;
      });

      // Attach section time info for non-video sections
      data.demographicsSectionTime = sectionTimes[0];
      data.section1Time = sectionTimes[2];
      data.section2Time = sectionTimes[4];
      data.section3Time = sectionTimes[6];

      fetch('/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(resp => resp.json())
      .then(res => {
        if (res.success) {
          currentSection++;
          showSection(currentSection);
          // Hide nav buttons after submit
          document.getElementById('prevBtn').style.display = 'none';
          document.getElementById('nextBtn').style.display = 'none';
        } else {
          alert('Error submitting data: ' + res.message);
        }
      })
      .catch(err => {
        alert('Error submitting data: ' + err.message);
      });
    }

    // Initialize first section display
    showSection(currentSection);
  </script>

</body>
</html>
